<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบบันทึกการยืมอุปกรณ์</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

  <h1 class="text-2xl font-bold mb-4">ระบบบันทึกการยืมอุปกรณ์</h1>

  <!-- ADMIN LOGIN -->
  <div class="mb-4">
    <label class="block mb-1 font-semibold">สำหรับผู้ดูแลระบบ: กรอกรหัสเพื่อปลดล็อก</label>
    <div class="flex space-x-2 items-center">
      <input id="adminPassword" type="password" placeholder="รหัสผ่านผู้ดูแลระบบ" class="border p-2">
      <button onclick="unlockAdmin()" class="bg-blue-500 text-white px-4 py-2">ปลดล็อก</button>
    </div>
    <p id="adminStatus" class="text-sm mt-1 text-red-600 hidden">รหัสผ่านไม่ถูกต้อง</p>
  </div>

  <!-- จัดการอุปกรณ์ -->
  <div>
    <h2 class="text-xl font-bold mb-2">จัดการอุปกรณ์</h2>
    <p id="adminOnlyNotice" class="text-sm text-red-600 mb-2">* เฉพาะผู้ดูแลระบบเท่านั้นที่สามารถเพิ่มหรือลบอุปกรณ์</p>
    <div class="flex flex-wrap items-center space-x-2 mb-2">
      <input id="equipmentName" type="text" placeholder="ชื่ออุปกรณ์" class="border p-2">
      <button id="addBtn" onclick="addEquipment()" class="bg-blue-500 text-white px-4 py-2" disabled>เพิ่ม</button>
      <select id="deleteSelect" multiple class="border p-2 w-60 h-20"></select>
      <button id="delBtn" onclick="deleteSelectedEquipment()" class="bg-red-500 text-white px-4 py-2" disabled>ลบที่เลือก</button>
    </div>
  </div>

  <hr class="my-4">

  <!-- บันทึกการยืม -->
  <div>
    <h2 class="text-xl font-bold mb-2">บันทึกการยืมอุปกรณ์</h2>
    <div class="flex flex-wrap items-center gap-2 mb-2">
      <input id="borrowerName" type="text" placeholder="ชื่อผู้ยืม" class="border p-2">
      <input id="borrowerContact" type="text" placeholder="เบอร์ติดต่อ" class="border p-2">
      <input id="usageDetail" type="text" placeholder="ใช้งานเรื่อง..." class="border p-2 w-60">
      <select id="borrowSelect" class="border p-2"></select>
      <input id="borrowTime" type="datetime-local" class="border p-2">
      <input id="returnTime" type="datetime-local" class="border p-2">
      <button onclick="borrowEquipment()" class="bg-green-500 text-white px-4 py-2">บันทึก</button>
    </div>
  </div>

  <hr class="my-4">

  <!-- ตารางบันทึก -->
  <div>
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-xl font-bold">รายการการยืม-คืน</h2>
      <button onclick="exportExcel()" class="bg-yellow-500 text-black px-4 py-2 rounded">Export Excel</button>
    </div>
    <table class="w-full border">
      <thead>
        <tr class="bg-gray-300 text-left">
          <th class="border px-2 py-1">ลำดับ</th>
          <th class="border px-2 py-1">วันที่</th>
          <th class="border px-2 py-1">ชื่อผู้ยืม</th>
          <th class="border px-2 py-1">เบอร์ติดต่อ</th>
          <th class="border px-2 py-1">ใช้งานเรื่อง</th>
          <th class="border px-2 py-1">อุปกรณ์</th>
          <th class="border px-2 py-1">เวลายืม</th>
          <th class="border px-2 py-1">เวลาคืน</th>
          <th class="border px-2 py-1">จัดการ</th>
        </tr>
      </thead>
      <tbody id="borrowLog"></tbody>
    </table>
  </div>

  <script>
    const ADMIN_PASSWORD = "admin123";
    let isAdmin = false;

    let equipmentList = JSON.parse(localStorage.getItem('equipmentList')) || [];
    let borrowLog = JSON.parse(localStorage.getItem('borrowLog')) || [];

    function unlockAdmin() {
      const pwd = document.getElementById("adminPassword").value;
      if (pwd === ADMIN_PASSWORD) {
        isAdmin = true;
        document.getElementById("addBtn").disabled = false;
        document.getElementById("delBtn").disabled = false;
        document.getElementById("adminOnlyNotice").textContent = "* ปลดล็อกแล้ว: คุณคือผู้ดูแลระบบ";
        document.getElementById("adminOnlyNotice").classList.remove("text-red-600");
        document.getElementById("adminOnlyNotice").classList.add("text-green-600");
        document.getElementById("adminStatus").classList.add("hidden");
        renderLogs();
      } else {
        document.getElementById("adminStatus").classList.remove("hidden");
      }
    }

    function renderLists() {
      const borrowSelect = document.getElementById("borrowSelect");
      const deleteSelect = document.getElementById("deleteSelect");

      borrowSelect.innerHTML = '';
      deleteSelect.innerHTML = '';
      equipmentList.forEach(item => {
        borrowSelect.innerHTML += <option value="${item}">${item}</option>;
        deleteSelect.innerHTML += <option value="${item}">${item}</option>;
      });
    }

    function renderLogs() {
      const borrowLogEl = document.getElementById("borrowLog");
      borrowLogEl.innerHTML = '';
      borrowLog.forEach((entry, index) => {
        borrowLogEl.innerHTML += <tr>
          <td class="border px-2 py-1">${index + 1}</td>
          <td class="border px-2 py-1">${entry.date}</td>
          <td class="border px-2 py-1">${entry.name}</td>
          <td class="border px-2 py-1">${entry.contact}</td>
          <td class="border px-2 py-1">${entry.usage}</td>
          <td class="border px-2 py-1">${entry.equipment}</td>
          <td class="border px-2 py-1">${entry.borrow}</td>
          <td class="border px-2 py-1">${entry.return}</td>
          <td class="border px-2 py-1">
            ${isAdmin ? <button onclick="deleteLog(${index})" class="bg-red-500 text-white px-2 py-1 text-sm">ลบ</button> : '<span class="text-gray-400 text-sm">ล็อก</span>'}
          </td>
        </tr>;
      });
    }

    function addEquipment() {
      const name = document.getElementById("equipmentName").value.trim();
      if (name && !equipmentList.includes(name)) {
        equipmentList.push(name);
        localStorage.setItem("equipmentList", JSON.stringify(equipmentList));
        renderLists();
        document.getElementById("equipmentName").value = '';
      }
    }

    function deleteSelectedEquipment() {
      const selected = Array.from(document.getElementById("deleteSelect").selectedOptions).map(o => o.value);
      equipmentList = equipmentList.filter(item => !selected.includes(item));
      localStorage.setItem("equipmentList", JSON.stringify(equipmentList));
      renderLists();
    }

    function borrowEquipment() {
      const name = document.getElementById("borrowerName").value.trim();
      const contact = document.getElementById("borrowerContact").value.trim();
      const usage = document.getElementById("usageDetail").value.trim();
      const equipment = document.getElementById("borrowSelect").value;
      const borrow = document.getElementById("borrowTime").value;
      const ret = document.getElementById("returnTime").value;
      const date = new Date().toLocaleDateString();

      if (name && contact && equipment && borrow && ret && usage) {
        borrowLog.push({ date, name, contact, usage, equipment, borrow, return: ret });
        localStorage.setItem("borrowLog", JSON.stringify(borrowLog));
        document.getElementById("borrowerName").value = '';
        document.getElementById("borrowerContact").value = '';
        document.getElementById("usageDetail").value = '';
        document.getElementById("borrowTime").value = '';
        document.getElementById("returnTime").value = '';
        renderLogs();
      }
    }

    function deleteLog(index) {
      if (isAdmin && confirm("ต้องการลบรายการนี้หรือไม่?")) {
        borrowLog.splice(index, 1);
        localStorage.setItem("borrowLog", JSON.stringify(borrowLog));
        renderLogs();
      }
    }

    function exportExcel() {
      const worksheet = XLSX.utils.json_to_sheet(borrowLog);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "BorrowLog");
      XLSX.writeFile(workbook, "BorrowLog.xlsx");
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderLists();
      renderLogs();
    });
  </script>
</body>
</html>  